<div class="detalle-ruta">
  <div class="cabecera">
    <button (click)="volver()">‚¨Ö Volver</button>
  </div>

  <h1>{{ ruta()?.nombrePersonalizado }}</h1>
  <p class="base">Zona base: {{ ruta()?.nombreBase }}</p>

  <div class="acciones-principales">
    <button class="btn-agregar" (click)="agregarDireccion()">
      ‚ûï Agregar direcci√≥n
    </button>

    <button class="btn-editar-ruta" (click)="editarRuta()">
      ‚úè Editar ruta
    </button>

    <button class="btn-subir-base" (click)="subirComoBase()">
      ‚¨Ü Subir a base
    </button>

    <button class="btn-exportar" (click)="exportarCSV()">‚¨á Exportar CSV</button>
  </div>

  <h2>Direcciones cargadas ({{ direcciones().length }})</h2>

  <div class="buscador">
    <input
      type="text"
      placeholder="Buscar direcci√≥n, cliente o notas..."
      [(ngModel)]="busqueda"
      (input)="filtrarBusqueda()"
    />
  </div>

  <div class="resultados" *ngIf="resultadosBusqueda().length > 0">
    <button
      class="resultado"
      *ngFor="let r of resultadosBusqueda()"
      type="button"
      (click)="irA(r)"
    >
      <div class="r-cliente">{{ r.cliente }}</div>
      <div class="r-dir">üìç {{ r.direccion }}</div>
    </button>
  </div>

  <div *ngIf="cargandoDirecciones()" class="loading">
    Cargando direcciones...
  </div>

  <div
    class="lista"
    *ngIf="!cargandoDirecciones() && direcciones().length > 0"
    cdkDropList
    [cdkDropListData]="direccionesFiltradas()"
    [cdkDropListDisabled]="!reordenHabilitado()"
    (cdkDropListDropped)="drop($event)"
  >
    <div
      class="card"
      *ngFor="let d of direccionesFiltradas(); let i = index"
      [attr.id]="'dir-' + d.id"
      [attr.data-dir-id]="d.id"
      [class.highlight]="resaltadoId() === d.id"
      cdkDrag
      [cdkDragDisabled]="!reordenHabilitado()"
      cdkDragLockAxis="y"
      (cdkDragMoved)="onDragMoved($event)"
      (cdkDragEnded)="onDragEnded()"
      (click)="abrirDetalle(d)"
    >
      <span class="badgeOrden" *ngIf="posicion(d) as p">#{{ p }}</span>
      <div
        class="drag-handle"
        *ngIf="!esRutaBase()"
        cdkDragHandle
        (click)="$event.stopPropagation()"
      >
        ‚ò∞
      </div>

      <div class="cliente">{{ d.cliente }}</div>
      <div class="direccion">üìç {{ d.direccion }}</div>
      <div class="info">üì∞ {{ d.cantidadDiarios }} diarios</div>
      <div class="acciones-card" *ngIf="!esRutaBase()">
        <button
          class="btn-mover"
          type="button"
          (click)="abrirMover(d); $event.stopPropagation()"
        >
          ‚ÜïÔ∏è Mover
        </button>
      </div>

      <!-- ‚úÖ Ya no usamos Subir/Bajar -->
    </div>
  </div>

  <p
    class="sin-datos"
    *ngIf="!cargandoDirecciones() && direccionesFiltradas().length === 0"
  >
    Esta ruta todav√≠a no tiene direcciones.
  </p>

  <!-- MODAL DETALLE -->
  <div class="modal-fondo" *ngIf="modalAbierto()">
    <div class="modal-contenido">
      <h2>{{ detalleSeleccionado()?.cliente }}</h2>
      <div *ngIf="detalleSeleccionado()?.bajas?.length" class="estado-baja">
        üö´ Cliente con baja programada
      </div>

      <p><strong>Direcci√≥n:</strong> {{ detalleSeleccionado()?.direccion }}</p>
      <p>
        <strong>Diarios:</strong> {{ detalleSeleccionado()?.cantidadDiarios }}
      </p>

      <p *ngIf="detalleSeleccionado()?.lat">
        <strong>Latitud:</strong> {{ detalleSeleccionado()?.lat }}
      </p>

      <p *ngIf="detalleSeleccionado()?.lng">
        <strong>Longitud:</strong> {{ detalleSeleccionado()?.lng }}
      </p>

      <p><strong>D√≠as:</strong></p>
      <ul>
        <li *ngIf="detalleSeleccionado()?.dias?.lunes">Lunes</li>
        <li *ngIf="detalleSeleccionado()?.dias?.martes">Martes</li>
        <li *ngIf="detalleSeleccionado()?.dias?.miercoles">Mi√©rcoles</li>
        <li *ngIf="detalleSeleccionado()?.dias?.jueves">Jueves</li>
        <li *ngIf="detalleSeleccionado()?.dias?.viernes">Viernes</li>
        <li *ngIf="detalleSeleccionado()?.dias?.sabado">S√°bado</li>
        <li *ngIf="detalleSeleccionado()?.dias?.domingo">Domingo</li>
        <li *ngIf="detalleSeleccionado()?.dias?.festivos">Festivos</li>
      </ul>

      <p *ngIf="detalleSeleccionado()?.notas">
        <strong>Notas:</strong><br />
        {{ detalleSeleccionado()?.notas }}
      </p>

      <div class="acciones-modal">
        <button class="btn-primario" (click)="abrirEnMaps()">
          üìç Ver en Google Maps
        </button>

        <button
          class="btn-secundario"
          (click)="editarDireccion(detalleSeleccionado()!.id!)"
        >
          Editar
        </button>

        <button class="btn-peligro" (click)="cerrarModal()">Cerrar</button>
      </div>
    </div>
  </div>
</div>
<button
  *ngIf="mostrarScrollTop"
  class="btn-scroll-top"
  (click)="volverArriba()"
>
  ‚¨Ü
</button>

<div class="backdrop" *ngIf="moverOpen()" (click)="cerrarMover()">
  <div class="sheet" (click)="$event.stopPropagation()">
    <div class="sheetTitle">Mover direcci√≥n</div>

    <div class="sheetText" *ngIf="moverDir() as dir">
      <strong>{{ dir.cliente }}</strong>
      <div class="muted">
        Eleg√≠ la posici√≥n (1 a {{ todasLasDirecciones.length }})
      </div>
    </div>

    <div class="fila-pos">
      <input
        class="input-pos"
        type="number"
        min="1"
        [max]="direcciones().length"
        [ngModel]="moverPos()"
        (ngModelChange)="moverPos.set($event)"
      />
    </div>

    <div class="sheetActions">
      <button class="btn ghost" type="button" (click)="cerrarMover()">
        Cancelar
      </button>

      <button class="btn peligro" type="button" (click)="confirmarMover()">
        Mover
      </button>
    </div>
  </div>
</div>
